<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream_AudioStat</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .overlay {
            margin: 0;
            padding: 0;
            padding-right: 20px;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .scroll-container {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .scroll-container.scrolling {
            animation: scroll-left 20s linear infinite;
            will-change: transform;
        }

        .content-wrapper {
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .overlay span {
            color: white;
            font-size: 16px;
            white-space: nowrap;
        }

        .mid {
            padding: 0 10px;
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay">
        <div class="scroll-container" id="scrollContainer">
            <div class="content-wrapper">
                <span class="title" id="title">Waiting for media...</span>
                <span class="mid"> | </span>
                <span class="artist" id="artist">—</span>
            </div>
        </div>
    </div>
    <script>
        const overlay = document.getElementById('overlay');
        const scrollContainer = document.getElementById('scrollContainer');
        const titleEl = document.getElementById('title');
        const artistEl = document.getElementById('artist');

        // Adds the scrolling effect to the text if needed
        function updateScrolling() {
            const overlayWidth = overlay.offsetWidth;
            const contentWidth = scrollContainer.firstElementChild.scrollWidth;
            
            scrollContainer.classList.remove('scrolling');
            scrollContainer.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'content-wrapper';
            wrapper.innerHTML = `
                <span class="title">${titleEl.getAttribute('data-original-text') || titleEl.textContent}</span>
                <span class="mid"> | </span>
                <span class="artist">${artistEl.getAttribute('data-original-text') || artistEl.textContent}</span>
            `;
            scrollContainer.appendChild(wrapper);
            
            if (wrapper.scrollWidth > overlayWidth) {
                const duplicate = wrapper.cloneNode(true);
                duplicate.style.marginLeft = '80px';
                scrollContainer.appendChild(duplicate);
                
                setTimeout(() => {
                    scrollContainer.classList.add('scrolling');
                }, 50);
            }
        }

        // Changes the text 
        function updateText(title, artist) {
            titleEl.setAttribute('data-original-text', title);
            artistEl.setAttribute('data-original-text', artist);
            titleEl.textContent = title;
            artistEl.textContent = artist;
            
            setTimeout(updateScrolling, 100);
        }

        // Connects and Listens to the Websocket on load 
        // Also checks for a window resize and checks if scrolling is needed
        function connectWebSocket() {
            const ws = new WebSocket('ws://localhost:8765');

            ws.onopen = () => {
                console.log('Connected to media server');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.title === '') {
                        updateText('Nothing is playing', '—');
                        overlay.classList.remove('active');
                    } else {
                        updateText(data.title || 'Unknown Title', data.artist || 'Unknown Artist');
                        overlay.classList.add('active');
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };

            ws.onerror = () => {
                console.error('WebSocket error');
            };

            ws.onclose = () => {
                console.log('Disconnected from media server');
                setTimeout(connectWebSocket, 3000);
            };
        }

        connectWebSocket();
        window.addEventListener('resize', updateScrolling);
    </script>
</body>
</html>